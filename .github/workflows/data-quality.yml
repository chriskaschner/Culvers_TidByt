name: Data Quality Gate

on:
  schedule:
    # Run weekly, Sunday 2 AM Central (8 AM UTC)
    - cron: '0 8 * * 0'
  workflow_dispatch:

jobs:
  backfill-coverage:
    name: D1 Backfill Coverage Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: uv sync

      - name: Install Node / wrangler
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install wrangler
        run: npm install -g wrangler
        working-directory: worker

      - name: Check D1 backfill coverage (priority stores)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: uv run python scripts/check_backfill_coverage.py --stores mt-horeb,verona,madison-todd-drive --min-pct 90
        # Exits nonzero if any priority store is below 90% D1/local coverage.
        # Requires CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID secrets.

  metrics-seed-freshness:
    name: Metrics Seed Freshness Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install Python dependencies
        run: uv sync

      - name: Check metrics seed age (<= 45 days)
        run: uv run python scripts/check_metrics_seed_freshness.py
